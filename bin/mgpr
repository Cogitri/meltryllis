#!/bin/sh
# SPDX-License-Identifier: GPL-3.0-only
# mgpr PR-NUM - Merges a pull request by number
#
# It is required to have a netrc file with the following structure present
# machine api.github.com
# login USER
# password PASSWORD
user=$(git config --get user.name)
r=0

cd "$(xdistdir)" || exit

while [ $# -gt 0 ]
do
	case $1 in
		''|*[!0-9]*) shift ; continue;;
		*) ;;
	esac

	label="$(curl --silent \
		  --request GET https://api.github.com/repos/void-linux/void-packages/pulls/"$1" |
		  jq --raw-output .head.label)"

	curl --netrc --fail --request PUT \
		 --data '{"merge_method":"rebase"}' \
		 https://api.github.com/repos/void-linux/void-packages/pulls/"$1"/merge \
		 >/dev/null 2>&1 ||
		 {
			 printerr "Failed to merge $1" ;
			 r=$((r+1))
			 [ $r -gt 3 ] && exit $r
			 continue ;
		 } &&
		 {
			printok "Merged Pull Request #$1" ;
			r=0
		 }
	
	shift


	if [ "$(echo "$label" | cut -d : -f1)" = "$user" ]
	then
		dlbr $(echo "$label" | cut -d : -f2)
	fi

	branch="$(echo "$label" | cut -d : -f2)"
	if git rev-parse --verify "$repo" >/dev/null 2>&1
	then
		dlbr $branch
	fi
done
