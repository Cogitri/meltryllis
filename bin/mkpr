#!/bin/sh
# SPDX-License-Identifier: GPL-3.0-only
# mkpr [BRANCH] ... - mgbr merge branches
[ "$EDIT" ] && EDIT="--edit" || EDIT="--no-edit"
for arg; do
	shift
	[ "$arg" = "-e" ] || [ "$arg" = "--edit" ] && EDIT="--edit" && continue
	[ -z "${arg##*-a=*}" ] && ASSIGN="-a ${arg##*=}" && continue
	[ -z "${arg##*-r=*}" ] && REVIEW="-r ${arg##*=}" && continue
	[ -z "${arg##*-l=*}" ] && LABEL="-l ${arg##*=}" && continue
	set -- "$@" "$arg"
done
[ "$#" -lt 1 ] && set "$(git rev-parse --abbrev-ref HEAD)"
selectcommit() {
	git show -s --format=%B $(git log upstream/master.."$1" --pretty='%h %s' |
							  fzy |
							  cut -d ' ' -f1)

}
pr() {
	git rebase upstream/master >/dev/null 2>&1
	git push -uf origin "$1" >/dev/null 2>&1
	if [ "$(git rev-list --count upstream/master.."$1")" -gt 1 ]
	then
		msg="$(selectcommit "$1")"
		hub pull-request -h "$1" -m "$msg" $EDIT $ASSIGN $REVIEW $LABEL
	else
		hub pull-request -h "$1" $EDIT $ASSIGN $REVIEW $LABEL
	fi
}
while [ $# -gt 0 ]
do
	pr "$1"
	shift
done
