#!/bin/sh
# it assumes the monitors are named 1 to 9
_bargeo="100x30+130+0"

create-fifo "$_fifo"

trap "rm -f $_fifo" EXIT QUIT TERM

# Wait for the bspwm socket to appear, path defined on BSPWM_SOCKET envvar
wait-path socket "${BSPWM_SOCKET:-'/tmp/bspwm_socket'}"

get_cur() {
	bspc query -D -d focused --names
}

desktop_wait() {
	cur="$(get_cur)"
	case "$cur" in
		1) echo '1st' > "$_fifo" ;;
		2) echo '2nd' > "$_fifo" ;;
		*) echo "${cur}th" > "$_fifo" ;;
	esac
	bspc subscribe desktop_focus |
		while read -r _; do
			cur="$(get_cur)"
			case "$cur" in
				1) echo '1st' > "$_fifo" ;;
				2) echo '2nd' > "$_fifo" ;;
				*) echo "${cur}th" > "$_fifo" ;;
			esac
		done
}

desktop_wait &
_w="$(bspc query -D | wc -l)"

while :; do
	echo "%{c}$(cat "$_fifo") wrkspace"
done | lemonbar -f "${_barfont}" \
				-f "${_barfont2}" \
				-B "${_barbg}" \
				-F "${_barfg}" \
				-g "${_bargeo}" \
				-b -n "${_n}"
