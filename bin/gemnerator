#!/bin/sh
#
# gemnerator <GEMS...> - Make templates for gems from rubygems
#
# Depends on:
# - xdistdir (xtools)
# - curl
# - jq
#
gem="${1?'no gem name given'}" # Name from rubygems
pkgname="ruby-$1" # Name for the template

# Get our xdistdir
templatedir=$(xdistdir)/srcpkgs/$pkgname

# Don't try to package gems that are part of ruby
dist_gems="bigdecimal json minitest net-telnet psych rake rdoc test-unit"
if [ -z "${dist_gems##*$gem*}" ]; then
	printf "[WARN] %s part of ruby.\\n" "$gem"
	return 0
fi

# We expect this script to run recursively and walk the whole
# dependency tree of a gem so just return when a package is
# already packaged
if [ -d "$templatedir" ]; then
	printf "[WARN] %s already packaged.\\n" "$gem"
	return 0
fi

# Use the rubygems API to get all information in json format
# we will use 'jq' to parse it
data="$(curl --silent https://rubygems.org/api/v1/gems/${gem}.json)"

if [ -z "$data" ]; then
	printf "[ERR] Can't fetch data for %s.\\n" "$gem"
	return 1
fi

# Get the values from the JSON data given to us
version="$(printf "%s" "$data" | jq -r .version)"

# Depends can be multiple values and due to jq we get them in multiple lines, use paste to
# join them with space between them.
deps="$(printf "%s" "$data" |
		jq -r '.dependencies.runtime | .[].name' |
		paste -sd ' ')"

# Try to get description from the summary field
short_desc="$(printf "%s" "$data" | jq -r '.summary // empty')"

# Licenses can be mulitple values and due to jq we get them in multiple lines, but unlike
# depends we need to have a comma-space separating them, so also pass a sed after using
# paste to join the lines
licenses="$(printf "%s" "$data" |
			jq -r 'select(.licenses != null).licenses | .[]' |
			paste -sd ' ' |
			sed 's| |, |g')"

# If homepage is null, which it can be, then return empty which is an empty string
homepage="$(printf "%s" "$data" | jq -r '.homepage_uri // empty')"

# If homepage is an empty string then we recieved null, we set it to the rubygems
# page of the gem
if [ -z "$homepage" ]
then
	homepage="https://rubygems.org/gems/$gem"
fi

# Get the sha256sum value for the gem
checksum="$(printf "%s" "$data" | jq -r '.sha //empty')"

# Run gemnerator against each dependency, this is recursive and it will walk
# the whole dependency chain
depends=""
for d in $deps
do
	printf "[DEPENDENCY]: %s -> %s.\\n" "$d" "$gem"
	"$0" "$d" || printf "[WARN] Failed to make template for %s.\\n" "$gem"
	if [ -z "${dist_gems##*$d*}" ]; then
		continue
	fi
	depends="${depends} ruby-$d"
done

# Everything seems ready to go!
printf "[OK] Creating template for %s.\\n" "$gem"

mkdir -p "$templatedir" 
# Output our template
cat >"$templatedir/template" <<EOF
# Template file for '$pkgname'
pkgname=$pkgname
version=$version
revision=1
noarch=yes
build_style=gem
$(test -z "$depends" || echo depends=\"$depends\" | sed 's|" |"|')
short_desc="$(test -z "${short_desc}" || echo "$short_desc")"
maintainer="$(git config user.name) <$(git config user.email)>"
license="$licenses"
homepage="$homepage"
checksum=$checksum
EOF
